name: Pact Contract Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PACT_BROKER_BASE_URL: https://varian-c836f1db.pactflow.io
  PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}  # Add your PactFlow API token as a GitHub secret
  # PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
  # PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}

jobs:
  consumer-tests:
    name: Consumer Contract Tests
    runs-on: windows-latest  # Use GitHub-hosted runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # No need to add hosts file - already configured on self-hosted runner
      
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore Consumer dependencies
        working-directory: Consumer
        run: dotnet restore
      
      - name: Run Consumer Tests
        working-directory: Consumer
        run: dotnet test --logger "console;verbosity=detailed" --no-restore
      
      - name: Upload Pact Files as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pacts
          path: Consumer/pacts/*.json
          if-no-files-found: error
      
      - name: Publish Pact to Broker
        env:
          BUILD_NUMBER: ${{ github.sha }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          .\publish-pact.ps1 -ConsumerVersion "$env:BUILD_NUMBER" -Token "$env:PACT_BROKER_TOKEN"

  provider-verification:
    name: Provider Verification Tests
    runs-on: windows-latest  # Use GitHub-hosted runner
    needs: consumer-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Download Pact Files
        uses: actions/download-artifact@v4
        with:
          name: pacts
          path: Consumer/pacts
      
      - name: List Downloaded Pacts
        run: dir Consumer\pacts
      
      - name: Restore Producer dependencies
        working-directory: Producer
        run: dotnet restore
      
      - name: Run Provider Verification Tests
        env:
          BUILD_NUMBER: ${{ github.sha }}
          BRANCH_NAME: ${{ github.ref_name }}
          PROVIDER_VERSION: ${{ github.sha }}
        run: |
          .\verify-provider.ps1 -ProviderVersion "$env:PROVIDER_VERSION"

  can-i-deploy:
    name: Can I Deploy Check
    runs-on: windows-latest
    needs: [consumer-tests, provider-verification]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Pact CLI (via Chocolatey)
        run: |
          choco install pact -y
          choco install pact-broker-cli -y
      
      - name: Check Can I Deploy (Consumer)
        env:
          BUILD_NUMBER: ${{ github.sha }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          $env:PATH = "C:\ProgramData\chocolatey\bin;$env:PATH"
          pact-broker can-i-deploy `
            --pacticipant SF-Consumer `
            --version "$env:BUILD_NUMBER" `
            --to-environment production `
            --broker-base-url "$env:PACT_BROKER_BASE_URL"
      
      - name: Check Can I Deploy (Provider)
        env:
          BUILD_NUMBER: ${{ github.sha }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          $env:PATH = "C:\ProgramData\chocolatey\bin;$env:PATH"
          pact-broker can-i-deploy `
            --pacticipant VAIS-Producer `
            --version "$env:BUILD_NUMBER" `
            --to-environment production `
            --broker-base-url "$env:PACT_BROKER_BASE_URL"
      
      - name: Record Deployment
        if: success()
        env:
          BUILD_NUMBER: ${{ github.sha }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          $env:PATH = "C:\ProgramData\chocolatey\bin;$env:PATH"
          
          # Record consumer deployment
          pact-broker record-deployment `
            --pacticipant SF-Consumer `
            --version "$env:BUILD_NUMBER" `
            --environment production `
            --broker-base-url "$env:PACT_BROKER_BASE_URL"
          
          # Record provider deployment
          pact-broker record-deployment `
            --pacticipant VAIS-Producer `
            --version "$env:BUILD_NUMBER" `
            --environment production `
            --broker-base-url "$env:PACT_BROKER_BASE_URL"
